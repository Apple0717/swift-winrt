import CodeWriters
import DotNetMetadata

struct SwiftNamespaceModuleFileWriter {
    private let sourceFileWriter: SwiftSourceFileWriter
    private let module: SwiftProjection.Module
    private var projection: SwiftProjection { module.projection }

    init(path: String, module: SwiftProjection.Module) {
        self.sourceFileWriter = SwiftSourceFileWriter(output: FileTextOutputStream(path: path))
        self.module = module

        sourceFileWriter.output.writeLine("// Generated by swift-winrt")
        sourceFileWriter.output.writeLine("// swiftlint:disable all")

        sourceFileWriter.writeImport(module: module.name)
    }

    func writeAlias(_ typeDefinition: TypeDefinition) throws {
        if let interface = typeDefinition as? InterfaceDefinition {
            sourceFileWriter.writeProtocol(
                visibility: SwiftProjection.toVisibility(interface.visibility),
                name: try projection.toProtocolName(interface, namespaced: false),
                typeParameters: interface.genericParams.map { $0.name },
                bases: [SwiftType.identifier(
                    name: try projection.toProtocolName(interface),
                    genericArgs: interface.genericParams.map { SwiftType.identifier(name: $0.name) })]) { _ in }
        }

        sourceFileWriter.writeTypeAlias(
            visibility: SwiftProjection.toVisibility(typeDefinition.visibility),
            name: try projection.toTypeName(typeDefinition, namespaced: false),
            typeParameters: typeDefinition.genericParams.map { $0.name },
            target: SwiftType.identifier(
                name: try projection.toTypeName(typeDefinition),
                genericArgs: typeDefinition.genericParams.map { SwiftType.identifier(name: $0.name) }))
    }
}